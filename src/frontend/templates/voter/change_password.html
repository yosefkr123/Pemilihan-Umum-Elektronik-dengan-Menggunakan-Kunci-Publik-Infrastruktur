{% extends "base.html" %}
{% block title %}Ganti Password{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden md:max-w-2xl my-8">
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-4 text-white">
        <h2 class="text-2xl font-bold text-center">Ganti Password</h2>
    </div>
    <div class="p-8">
        <!-- Notification Container -->
        <div id="notification-container" class="fixed top-4 right-4 space-y-3 z-50 w-80"></div>
        
        <form method="POST" class="space-y-4">
            <!-- Current Password -->
            <div class="relative">
                <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">Password Saat Ini</label>
                <div class="relative">
                    <input type="password" id="current_password" name="current_password" 
                           class="input-field w-full pr-10" required>
                    <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none toggle-password">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <!-- New Password -->
            <div class="relative">
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                <div class="relative">
                    <input type="password" id="new_password" name="new_password" 
                           class="input-field w-full pr-10" required minlength="8">
                    <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none toggle-password">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Minimal 8 karakter</p>
            </div>
            
            <!-- Confirm Password -->
            <div class="relative">
                <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password Baru</label>
                <div class="relative">
                    <input type="password" id="confirm_password" name="confirm_password" 
                           class="input-field w-full pr-10" required minlength="8">
                    <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none toggle-password">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <!-- OTP Section -->
            <div class="flex items-end space-x-2">
                <div class="flex-1">
                    <label for="otp" class="block text-sm font-medium text-gray-700 mb-1">Kode OTP</label>
                    <input type="text" id="otp" name="otp" 
                           class="input-field w-full" placeholder="Masukkan 6 digit kode" 
                           pattern="\d{6}" title="Harap masukkan 6 digit angka">
                </div>
                <button type="button" id="request-otp-btn" 
                        class="btn-primary px-4 py-2 h-[42px] rounded-lg flex items-center space-x-1 whitespace-nowrap">
                    <i class="fas fa-key"></i>
                    <span>Minta OTP</span>
                </button>
            </div>
            <p class="text-xs text-gray-500 -mt-2">Kode OTP akan dikirim ke email Anda</p>
            
            <!-- Submit Button -->
            <button type="submit" id="submit-btn" 
                    class="btn-primary w-full py-2 rounded-lg bg-green-600 hover:bg-green-700 flex items-center justify-center space-x-2 mt-4">
                <i class="fas fa-check"></i>
                <span>Ganti Password</span>
            </button>
        </form>
    </div>
</div>

<style>
/* Input Field Styling */
.input-field {
    transition: all 0.3s ease;
    border: 2px solid #e2e8f0;
    background-color: #f8fafc;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.input-field:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    background-color: white;
}

/* Button Styling */
.btn-primary {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
    color: white;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
}

/* Notification Styling */
.notification {
    position: relative;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    animation: slideIn 0.3s ease-out forwards;
    overflow: hidden;
    border-left: 4px solid;
    background: white;
}

.notification::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    width: 100%;
    background: currentColor;
    opacity: 0.2;
}

.notification-success {
    border-left-color: #10b981;
    color: #065f46;
}

.notification-error {
    border-left-color: #ef4444;
    color: #b91c1c;
}

.notification-info {
    border-left-color: #3b82f6;
    color: #1e40af;
}

.notification-warning {
    border-left-color: #f59e0b;
    color: #92400e;
}

.notification-icon {
    font-size: 1.25rem;
    margin-right: 0.75rem;
}

.notification-content {
    flex: 1;
}

.notification-close {
    margin-left: 0.75rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.notification-close:hover {
    opacity: 1;
}

/* Animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeOut {
    to {
        opacity: 0;
        transform: translateX(20px);
    }
}

.notification.fade-out {
    animation: fadeOut 0.3s ease-in forwards;
}

/* Progress Bar Animation */
@keyframes progress {
    to {
        transform: scaleX(0);
    }
}

.progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: currentColor;
    opacity: 0.2;
    transform-origin: left;
    animation: progress 5s linear forwards;
}
</style>

<script>
// Password visibility toggle
document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
        const input = this.previousElementSibling;
        const icon = this.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    });
});

// Show notification function
function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    
    // Set notification classes
    notification.className = `notification notification-${type}`;
    
    // Notification icon based on type
    let iconClass;
    switch(type) {
        case 'success': iconClass = 'fas fa-check-circle'; break;
        case 'error': iconClass = 'fas fa-exclamation-circle'; break;
        case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
        default: iconClass = 'fas fa-info-circle';
    }
    
    // Notification content
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="notification-content">
            ${message}
        </div>
        <button class="notification-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="progress-bar"></div>
    `;
    
    // Add to container
    container.appendChild(notification);
    
    // Auto-remove after duration
    const timer = setTimeout(() => {
        notification.classList.add('fade-out');
        notification.addEventListener('animationend', () => {
            notification.remove();
        });
    }, duration);
    
    // Manual close
    notification.querySelector('.notification-close').addEventListener('click', () => {
        clearTimeout(timer);
        notification.classList.add('fade-out');
        notification.addEventListener('animationend', () => {
            notification.remove();
        });
    });
}

// OTP request functionality
document.getElementById('request-otp-btn').addEventListener('click', async function() {
    const currentPass = document.getElementById('current_password').value;
    
    if (!currentPass) {
        showNotification('Harap masukkan password saat ini terlebih dahulu', 'error');
        return;
    }
    
    // Show loading state
    const otpBtn = this;
    otpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
    otpBtn.disabled = true;
    
    try {
        const response = await fetch('/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPass,
                request_otp: true
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('OTP telah dikirim ke email Anda', 'success');
        } else {
            showNotification(data.message || 'Gagal mengirim OTP. Silakan coba lagi.', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Terjadi kesalahan saat meminta OTP', 'error');
    } finally {
        // Reset button state
        otpBtn.innerHTML = '<i class="fas fa-key"></i><span>Minta OTP</span>';
        otpBtn.disabled = false;
    }
});

// Form submission handler
document.querySelector('form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPass = document.getElementById('current_password').value;
    const newPass = document.getElementById('new_password').value;
    const confirmPass = document.getElementById('confirm_password').value;
    const otp = document.getElementById('otp').value;
    
    // Basic validation
    if (!currentPass || !newPass || !confirmPass || !otp) {
        showNotification('Harap isi semua field yang diperlukan', 'error');
        return;
    }
    
    if (newPass !== confirmPass) {
        showNotification('Password baru dan konfirmasi password tidak cocok', 'error');
        return;
    }
    
    if (otp.length !== 6 || !/^\d+$/.test(otp)) {
        showNotification('Kode OTP harus 6 digit angka', 'error');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/change_password', {
            method: 'POST',
            body: JSON.stringify({
                current_password: currentPass,
                new_password: newPass,
                confirm_password: confirmPass,
                otp: otp
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('Password berhasil diubah!', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1500);
        } else {
            showNotification(data.message || 'Gagal mengubah password. Silakan cek data Anda.', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Terjadi kesalahan saat mengubah password', 'error');
    } finally {
        submitBtn.innerHTML = '<i class="fas fa-check"></i><span>Ganti Password</span>';
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}